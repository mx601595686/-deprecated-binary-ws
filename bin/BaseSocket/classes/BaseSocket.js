"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Emitter = require("component-emitter");
/**
 * websocket 接口的抽象类，定义了需要实现的基础功能
 */
class BaseSocket extends Emitter {
    constructor(socket, configs) {
        super();
        /**
         * _messageID 的ID号，id从0开始。每发一条消息，该id加1。
         */
        this._messageID = 0;
        /**
         * 消息的发送队列。如果要取消发送，可以向send中传递以error
         */
        this._sendingQueue = new Map();
        this.id = BaseSocket._id_Number++;
        this._socket = socket;
        this.url = configs.url;
        this.maxPayload = configs.maxPayload == null || configs.maxPayload <= 0 ? 0 : configs.maxPayload + 1024;
        this.once('close', () => {
            for (let item of [...this._sendingQueue.keys()].reverse())
                this.cancel(item, new Error('连接中断'));
        });
    }
    /**
     * 连接的当前状态
     */
    get readyState() {
        return this._socket.readyState;
    }
    /**
     * 在缓冲队列中等待发送的数据大小
     */
    get bufferedAmount() {
        let size = 0;
        for (let item of this._sendingQueue.values()) {
            size += item.size;
        }
        return size;
    }
    /**
     * 发送消息。(返回的promise中包含该条消息的messageID)
     * @param title 消息的标题
     * @param data 携带的数据
     */
    send(title, data) {
        const messageID = this._messageID++;
        const result = new Promise((resolve, reject) => {
            const b_title = Buffer.from(title);
            const b_title_length = Buffer.alloc(4);
            b_title_length.writeUInt32BE(b_title.length, 0);
            const r_data = Buffer.concat([b_title_length, b_title, data]);
            if (this.maxPayload !== 0 && r_data.length > this.maxPayload)
                throw new Error('发送的消息大小超出了限制');
            const send = (err) => {
                if (err != null) {
                    reject(err);
                    this._sendingQueue.delete(messageID);
                }
                else {
                    this._sendData(r_data).then(() => {
                        this._sendingQueue.delete(messageID);
                        resolve();
                    }).catch((err) => {
                        this._sendingQueue.delete(messageID);
                        reject(err);
                    }).then(() => {
                        if (this._sendingQueue.size > 0)
                            this._sendingQueue.values().next().value.send();
                    });
                }
            };
            this._sendingQueue.set(messageID, { size: r_data.length, send });
            if (this._sendingQueue.size === 1)
                send(); //如果没有消息排队就直接发送
        });
        result.messageID = messageID;
        return result;
    }
    /**
     * 取消发送
     * @param messageID 要取消发送消息的messageID
     * @param err 传递一个error，指示取消的原因
     */
    cancel(messageID, err = new Error('发送取消')) {
        const item = this._sendingQueue.get(messageID);
        if (item != null)
            item.send(err);
    }
    /**
     * 解析接收到数据。子类接收到消息后需要触发这个方法
     *
     * @param data 接收到数据
     */
    _receiveData(data) {
        try {
            let offset = 0;
            const title_length = data.readUInt32BE(0);
            offset += 4;
            const title = data.slice(offset, offset += title_length).toString();
            const r_data = data.slice(offset);
            this.emit('message', title, r_data);
        }
        catch (error) {
            this.emit('error', error);
        }
    }
    on(event, listener) {
        super.on(event, listener);
        return this;
    }
    once(event, listener) {
        super.once(event, listener);
        return this;
    }
}
/**
 * 每新建一个接口+1
 */
BaseSocket._id_Number = 0;
exports.BaseSocket = BaseSocket;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkJhc2VTb2NrZXQvY2xhc3Nlcy9CYXNlU29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQTZDO0FBTTdDOztHQUVHO0FBQ0gsZ0JBQWlDLFNBQVEsT0FBTztJQW1ENUMsWUFBWSxNQUFzQixFQUFFLE9BQXlCO1FBQ3pELEtBQUssRUFBRSxDQUFDO1FBN0NaOztXQUVHO1FBQ0ssZUFBVSxHQUFHLENBQUMsQ0FBQztRQUV2Qjs7V0FFRztRQUNjLGtCQUFhLEdBQStELElBQUksR0FBRyxFQUFFLENBQUM7UUF1Q25HLElBQUksQ0FBQyxFQUFFLEdBQUcsVUFBVSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQztRQUN2QixJQUFJLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxVQUFVLElBQUksSUFBSSxJQUFJLE9BQU8sQ0FBQyxVQUFVLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUV4RyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNmLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ3RELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDN0MsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBaENEOztPQUVHO0lBQ0gsSUFBSSxVQUFVO1FBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO0lBQ25DLENBQUM7SUFFRDs7T0FFRztJQUNILElBQUksY0FBYztRQUNkLElBQUksSUFBSSxHQUFHLENBQUMs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b2NrZXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBFbWl0dGVyIGZyb20gJ2NvbXBvbmVudC1lbWl0dGVyJztcclxuaW1wb3J0ICogYXMgV1MgZnJvbSAnd3MnO1xyXG5cclxuaW1wb3J0IHsgUmVhZHlTdGF0ZSB9IGZyb20gXCIuLi9pbnRlcmZhY2VzL1JlYWR5U3RhdGVcIjtcclxuaW1wb3J0IHsgQmFzZVNvY2tldENvbmZpZyB9IGZyb20gJy4uL2ludGVyZmFjZXMvQmFzZVNvY2tldENvbmZpZyc7XHJcblxyXG4vKipcclxuICogd2Vic29ja2V0IOaOpeWPo+eahOaKveixoeexu++8jOWumuS5ieS6humcgOimgeWunueOsOeahOWfuuehgOWKn+iDvVxyXG4gKi9cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEJhc2VTb2NrZXQgZXh0ZW5kcyBFbWl0dGVyIHtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOavj+aWsOW7uuS4gOS4quaOpeWPoysxXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc3RhdGljIF9pZF9OdW1iZXIgPSAwO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogX21lc3NhZ2VJRCDnmoRJROWPt++8jGlk5LuOMOW8gOWni+OAguavj+WPkeS4gOadoea2iOaBr++8jOivpWlk5YqgMeOAglxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9tZXNzYWdlSUQgPSAwO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5raI5oGv55qE5Y+R6YCB6Zif5YiX44CC5aaC5p6c6KaB5Y+W5raI5Y+R6YCB77yM5Y+v5Lul5ZCRc2VuZOS4reS8oOmAkuS7pWVycm9yXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX3NlbmRpbmdRdWV1ZTogTWFwPG51bWJlciwgeyBzaXplOiBudW1iZXIsIHNlbmQ6IChlcnI/OiBFcnJvcikgPT4gdm9pZCB9PiA9IG5ldyBNYXAoKTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOS/neWtmOiiq+WMheijheeahHNvY2tldOWvueixoVxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgX3NvY2tldDogV2ViU29ja2V0IHwgV1M7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlvZPliY3mjqXlj6PnmoRpZFxyXG4gICAgICovXHJcbiAgICByZWFkb25seSBpZDogbnVtYmVyO1xyXG5cclxuICAgIHJlYWRvbmx5IHVybDogc3RyaW5nO1xyXG5cclxuICAgIHJlYWRvbmx5IG1heFBheWxvYWQ6IG51bWJlcjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOi/nuaOpeeahOW9k+WJjeeKtuaAgVxyXG4gICAgICovXHJcbiAgICBnZXQgcmVhZHlTdGF0ZSgpOiBSZWFkeVN0YXRlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc29ja2V0LnJlYWR5U3RhdGU7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlnKjnvJPlhrLpmJ/liJfkuK3nrYnlvoXlj5HpgIHnmoTmlbDmja7lpKflsI9cclxuICAgICAqL1xyXG4gICAgZ2V0IGJ1ZmZlcmVkQW1vdW50KCk6IG51bWJlciB7XHJcbiAgICAgICAgbGV0IHNpemUgPSAwO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpdGVtIG9mIHRoaXMuX3NlbmRpbmdRdWV1ZS52YWx1ZXMoKSkge1xyXG4gICAgICAgICAgICBzaXplICs9IGl0ZW0uc2l6ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBzaXplO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHNvY2tldDogV2ViU29ja2V0IHwgV1MsIGNvbmZpZ3M6IEJhc2VTb2NrZXRDb25maWcpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG5cclxuICAgICAgICB0aGlzLmlkID0gQmFzZVNvY2tldC5faWRfTnVtYmVyKys7XHJcbiAgICAgICAgdGhpcy5fc29ja2V0ID0gc29ja2V0O1xyXG4gICAgICAgIHRoaXMudXJsID0gY29uZmlncy51cmw7XHJcbiAgICAgICAgdGhpcy5tYXhQYXlsb2FkID0gY29uZmlncy5tYXhQYXlsb2FkID09IG51bGwgfHwgY29uZmlncy5tYXhQYXlsb2FkIDw9IDAgPyAwIDogY29uZmlncy5tYXhQYXlsb2FkICsgMTAyNDtcclxuXHJcbiAgICAgICAgdGhpcy5vbmNlKCdjbG9zZScsICgpID0+IHsgICAgLy/lpoLmnpzmlq3lvIDvvIznu4jmraLmiYDmnInov5jmnKrlj5HpgIHnmoTmtojmga/jgILku47lkI7lkJHliY3lj5bmtohcclxuICAgICAgICAgICAgZm9yIChsZXQgaXRlbSBvZiBbLi4udGhpcy5fc2VuZGluZ1F1ZXVlLmtleXMoKV0ucmV2ZXJzZSgpKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5jYW5jZWwoaXRlbSwgbmV3IEVycm9yKCfov57mjqXkuK3mlq0nKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDpnIDopoHlrZDnsbvopoblhpnjgILnlKjkuo7lj5HpgIHmlbDmja5cclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGFzeW5jIF9zZW5kRGF0YShkYXRhOiBCdWZmZXIpOiBQcm9taXNlPHZvaWQ+O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5YWz6Zet5o6l5Y+j44CC5YWz6Zet5LmL5ZCO5Lya6Kem5Y+RY2xvc2Xkuovku7ZcclxuICAgICAqL1xyXG4gICAgYWJzdHJhY3QgY2xvc2UoKTogdm9pZDtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWPkemAgea2iOaBr+OAgijov5Tlm57nmoRwcm9taXNl5Lit5YyF5ZCr6K+l5p2h5raI5oGv55qEbWVzc2FnZUlEKVxyXG4gICAgICogQHBhcmFtIHRpdGxlIOa2iOaBr+eahOagh+mimFxyXG4gICAgICogQHBhcmFtIGRhdGEg5pC65bim55qE5pWw5o2uXHJcbiAgICAgKi9cclxuICAgIHNlbmQodGl0bGU6IHN0cmluZywgZGF0YTogQnVmZmVyKTogUHJvbWlzZTx2b2lkPiAmIHsgbWVzc2FnZUlEOiBudW1iZXIgfSB7XHJcbiAgICAgICAgY29uc3QgbWVzc2FnZUlEID0gdGhpcy5fbWVzc2FnZUlEKys7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBiX3RpdGxlID0gQnVmZmVyLmZyb20odGl0bGUpO1xyXG4gICAgICAgICAgICBjb25zdCBiX3RpdGxlX2xlbmd0aCA9IEJ1ZmZlci5hbGxvYyg0KTtcclxuICAgICAgICAgICAgYl90aXRsZV9sZW5ndGgud3JpdGVVSW50MzJCRShiX3RpdGxlLmxlbmd0aCwgMCk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCByX2RhdGEgPSBCdWZmZXIuY29uY2F0KFtiX3RpdGxlX2xlbmd0aCwgYl90aXRsZSwgZGF0YV0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMubWF4UGF5bG9hZCAhPT0gMCAmJiByX2RhdGEubGVuZ3RoID4gdGhpcy5tYXhQYXlsb2FkKVxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCflj5HpgIHnmoTmtojmga/lpKflsI/otoXlh7rkuobpmZDliLYnKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHNlbmQgPSAoZXJyPzogRXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3NlbmRpbmdRdWV1ZS5kZWxldGUobWVzc2FnZUlEKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VuZERhdGEocl9kYXRhKS50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VuZGluZ1F1ZXVlLmRlbGV0ZShtZXNzYWdlSUQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZW5kaW5nUXVldWUuZGVsZXRlKG1lc3NhZ2VJRCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fc2VuZGluZ1F1ZXVlLnNpemUgPiAwKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VuZGluZ1F1ZXVlLnZhbHVlcygpLm5leHQoKS52YWx1ZS5zZW5kKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuX3NlbmRpbmdRdWV1ZS5zZXQobWVzc2FnZUlELCB7IHNpemU6IHJfZGF0YS5sZW5ndGgsIHNlbmQgfSk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9zZW5kaW5nUXVldWUuc2l6ZSA9PT0gMSkgc2VuZCgpOyAgLy/lpoLmnpzmsqHmnInmtojmga/mjpLpmJ/lsLHnm7TmjqXlj5HpgIFcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmVzdWx0Lm1lc3NhZ2VJRCA9IG1lc3NhZ2VJRDtcclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Y+W5raI5Y+R6YCBXHJcbiAgICAgKiBAcGFyYW0gbWVzc2FnZUlEIOimgeWPlua2iOWPkemAgea2iOaBr+eahG1lc3NhZ2VJRFxyXG4gICAgICogQHBhcmFtIGVyciDkvKDpgJLkuIDkuKplcnJvcu+8jOaMh+ekuuWPlua2iOeahOWOn+WboFxyXG4gICAgICovXHJcbiAgICBjYW5jZWwobWVzc2FnZUlEOiBudW1iZXIsIGVycjogRXJyb3IgPSBuZXcgRXJyb3IoJ+WPkemAgeWPlua2iCcpKSB7XHJcbiAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMuX3NlbmRpbmdRdWV1ZS5nZXQobWVzc2FnZUlEKTtcclxuICAgICAgICBpZiAoaXRlbSAhPSBudWxsKSBpdGVtLnNlbmQoZXJyKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOino+aekOaOpeaUtuWIsOaVsOaNruOAguWtkOexu+aOpeaUtuWIsOa2iOaBr+WQjumcgOimgeinpuWPkei/meS4quaWueazlVxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0gZGF0YSDmjqXmlLbliLDmlbDmja5cclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIF9yZWNlaXZlRGF0YShkYXRhOiBCdWZmZXIpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBsZXQgb2Zmc2V0ID0gMDtcclxuICAgICAgICAgICAgY29uc3QgdGl0bGVfbGVuZ3RoID0gZGF0YS5yZWFkVUludDMyQkUoMCk7IG9mZnNldCArPSA0O1xyXG4gICAgICAgICAgICBjb25zdCB0aXRsZSA9IGRhdGEuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKz0gdGl0bGVfbGVuZ3RoKS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICBjb25zdCByX2RhdGEgPSBkYXRhLnNsaWNlKG9mZnNldCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ21lc3NhZ2UnLCB0aXRsZSwgcl9kYXRhKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBvbihldmVudDogJ2Vycm9yJywgbGlzdGVuZXI6IChlcnI6IEVycm9yKSA9PiB2b2lkKTogdGhpc1xyXG4gICAgLyoqXHJcbiAgICAgKiDlvZPmlLbliLDmtojmga9cclxuICAgICAqL1xyXG4gICAgb24oZXZlbnQ6ICdtZXNzYWdlJywgbGlzdGVuZXI6ICh0aXRsZTogc3RyaW5nLCBkYXRhOiBCdWZmZXIpID0+IHZvaWQpOiB0aGlzXHJcbiAgICAvKipcclxuICAgICAqIOW9k+i/nuaOpeW7uueri1xyXG4gICAgICovXHJcbiAgICBvbihldmVudDogJ29wZW4nLCBsaXN0ZW5lcjogKCkgPT4gdm9pZCk6IHRoaXNcclxuICAgIC8qKlxyXG4gICAgICog5pat5byA6L+e5o6lXHJcbiAgICAgKi9cclxuICAgIG9uKGV2ZW50OiAnY2xvc2UnLCBsaXN0ZW5lcjogKGNvZGU6IG51bWJlciwgcmVhc29uOiBzdHJpbmcpID0+IHZvaWQpOiB0aGlzXHJcbiAgICBvbihldmVudDogc3RyaW5nLCBsaXN0ZW5lcjogRnVuY3Rpb24pOiB0aGlzIHtcclxuICAgICAgICBzdXBlci5vbihldmVudCwgbGlzdGVuZXIpO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIG9uY2UoZXZlbnQ6ICdlcnJvcicsIGxpc3RlbmVyOiAoZXJyOiBFcnJvcikgPT4gdm9pZCk6IHRoaXNcclxuICAgIG9uY2UoZXZlbnQ6ICdtZXNzYWdlJywgbGlzdGVuZXI6ICh0aXRsZTogc3RyaW5nLCBkYXRhOiBCdWZmZXIpID0+IHZvaWQpOiB0aGlzXHJcbiAgICBvbmNlKGV2ZW50OiAnb3BlbicsIGxpc3RlbmVyOiAoKSA9PiB2b2lkKTogdGhpc1xyXG4gICAgb25jZShldmVudDogJ2Nsb3NlJywgbGlzdGVuZXI6IChjb2RlOiBudW1iZXIsIHJlYXNvbjogc3RyaW5nKSA9PiB2b2lkKTogdGhpc1xyXG4gICAgb25jZShldmVudDogc3RyaW5nLCBsaXN0ZW5lcjogRnVuY3Rpb24pOiB0aGlzIHtcclxuICAgICAgICBzdXBlci5vbmNlKGV2ZW50LCBsaXN0ZW5lcik7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcbn0iXX0=
