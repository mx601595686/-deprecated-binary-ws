"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Emitter = require("component-emitter");
const object2buffer_1 = require("object2buffer");
/**
 * Socket 接口的抽象类，定义了socket需要实现的基础功能
 */
class BaseSocket extends Emitter {
    constructor(configs) {
        super();
        /**
         * _messageID 的ID号，id从0开始。每发一条消息，该id加1
         */
        this._messageID = 0;
        /**
         * 等待发送消息的队列。key：messageID。
         */
        this._queue = new Map();
        this.url = configs.url;
        this._needDeserialize = configs.needDeserialize === undefined ? true : configs.needDeserialize;
        this._maxPayload = configs.maxPayload === undefined ? 1024 * 1024 * 100 : configs.maxPayload;
        if (configs.socket === undefined)
            throw new Error('传入BaseSocket的configs.socket不可以为空');
        else
            this._socket = configs.socket;
        this.once('close', () => {
            for (let item of [...this._queue.values()].reverse()) {
                const result = item.cancel(new Error('连接中断'));
                if (result === false)
                    item.ack(new Error('连接中断')); //取消正在发送的
            }
        });
    }
    /**
     * 连接的当前状态
     */
    get readyState() {
        return this._socket.readyState;
    }
    /**
     * 在缓冲队列中等待发送的数据字节数
     */
    get bufferedAmount() {
        let size = 0;
        for (let item of this._queue.values()) {
            size += item.data.length;
        }
        return size;
    }
    /**
     * 序列化消息头部。
     *
     * @private
     * @param {boolean} isInternal 是否是内部消息
     * @param {dataType} messageName 消息的名称
     * @param {boolean} needACK
     * @param {number} messageID
     * @returns {Buffer}
     * @memberof BaseSocket
     */
    _serializeHeader(isInternal, messageName, needACK, messageID) {
        const header = object2buffer_1.serialize([isInternal, needACK, messageID, messageName]);
        const headerLength = object2buffer_1.NodeBuffer.alloc(8);
        headerLength.writeDoubleBE(header.length, 0);
        return object2buffer_1.NodeBuffer.concat([headerLength, header]);
    }
    /**
     * 反序列化头部
     */
    _deserializeHeader(data) {
        const headerLength = data.readDoubleBE(0);
        const header = object2buffer_1.deserialize(data.slice(8, headerLength));
        return {
            isInternal: header[0],
            needACK: header[1],
            messageID: header[2],
            messageName: header[3],
            headerLength: 8 + headerLength
        };
    }
    /**
     * 发送数据。发送失败直接抛出异常
     *
     * @param {dataType} messageName 消息的名称(标题)
     * @param {dataType[]} [data=[]] 要发送的数据。如果是传入的是数组，则数据将使用object2buffer进行序列化。如果传入的是Buffer，则将直接被发送。(注意：传入的Buffer如果不是object2buffer序列化产生的，则需要接收方设置needDeserialize = false)
     * @param {boolean} [needACK=true] 发出的这条消息是否需要确认对方是否已经收到
     * @param {boolean} [prior=false] 是否直接发送（在缓冲队列中排队。默认false）
     * @returns {(Promise<void> & { messageID: number })} messageID
     */
    send(messageName, data = [], needACK = true, prior = false) {
        return this._send(false, prior, messageName, needACK, data);
    }
    /**
      * 发送内部数据。发送失败直接抛出异常。内部数据默认不需要接收端确认 ，并且默认优先发送
      * 注意：要在每一个调用的地方做好异常处理
      */
    _sendInternal(messageName, data = [], needACK = false, prior = true) {
        return this._send(true, prior, messageName, needACK, data);
    }
    _send(isInternal, prior, messageName, needACK, data) {
        const msgID = this._messageID++;
        const prom = new Promise((resolve, reject) => {
            const header = this._serializeHeader(isInternal, messageName, needACK, msgID);
            let sendingData; //要发送的数据
            if (Array.isArray(data))
                sendingData = object2buffer_1.NodeBuffer.concat([header, object2buffer_1.serialize(data)]);
            else
                sendingData = object2buffer_1.NodeBuffer.concat([header, data]);
            if (sendingData.length >= this._maxPayload) {
                throw new Error('发送的数据大小超过了限制');
            }
            const control = {
                data: sendingData,
                messageID: msgID,
                sent: false,
                cancel: (err) => {
                    if (control.sent)
                        return false;
                    else {
                        this._queue.delete(msgID);
                        err ? reject(err) : resolve();
                        return true;
                    }
                },
                send: () => {
                    if (control.sent)
                        return; //避免重复发送
                    control.sent = true;
                    if (needACK) {
                        this._sendData(sendingData).catch(control.ack);
                    }
                    else {
                        this._sendData(sendingData).then(control.ack).catch(control.ack);
                    }
                },
                ack: (err) => {
                    const isFirst = this._queue.values().next().value === control;
                    this._queue.delete(msgID);
                    err ? reject(err) : resolve();
                    if (isFirst && this._queue.size > 0)
                        this._queue.values().next().value.send();
                }
            };
            this._queue.set(msgID, control); //添加到队列中
            if (prior || this._queue.size === 1) {
                control.send();
            }
        });
        prom.messageID = msgID;
        return prom;
    }
    /**
     * 解析接收到数据。子类接收到消息后需要触发这个方法
     *
     * @protected
     * @param {Buffer} data 接收到数据
     * @memberof BaseSocket
     */
    _receiveData(data) {
        try {
            const header = this._deserializeHeader(data);
            if (header.needACK)
                this._sendInternal('ack', [header.messageID]).catch(err => this.emit('error', err));
            if (header.isInternal) {
                const body = object2buffer_1.deserialize(data.slice(header.headerLength));
                switch (header.messageName) {
                    case 'ack':
                        const callback = this._queue.get(body[0]);
                        callback && callback.ack();
                        break;
                }
            }
            else {
                const body = this._needDeserialize ? object2buffer_1.deserialize(data.slice(header.headerLength)) : data.slice(header.headerLength);
                setTimeout(() => {
                    this.emit('message', header.messageName, body);
                }, 0);
            }
        }
        catch (error) {
            this.emit('error', error);
        }
    }
    /**
     * 取消发送。如果某条消息还没有被发送则可以被取消。取消成功返回true，失败false
     *
     * @param {number} messageID 要取消发送消息的messageID
     * @param {Error} [err] 传递一个error，指示本次发送失败的原因
     * @returns {boolean} 取消成功返回true，失败false
     * @memberof BaseSocket
     */
    cancel(messageID, err) {
        const control = this._queue.get(messageID);
        if (control) {
            return control.cancel(err);
        }
        return false;
    }
    on(event, listener) {
        super.on(event, listener);
        return this;
    }
    once(event, listener) {
        super.once(event, listener);
        return this;
    }
}
exports.BaseSocket = BaseSocket;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SUFBSSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNuRCxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDVixDQUFDO1FBQ0wsQ0FBQztRQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDYixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM5QixDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7Ozs7O09BT0c7SUFDSCxNQUFNLENBQUMsU0FBaUIsRUFBRSxHQUFXO1FBQ2pDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTNDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDVixNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQixDQUFDO1FBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBd0JELEVBQUUsQ0FBQyxLQUFhLEVBQUUsUUFBa0I7UUFDaEMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNoQixDQUFDO0lBTUQsSUFBSSxDQUFDLEtBQWEsRUFBRSxRQUFrQjtRQUNsQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztRQUM1QixNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSjtBQXpSRCxnQ0F5UkMiLCJmaWxlIjoiY29tbW9uL0Jhc2VTb2NrZXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBFbWl0dGVyIGZyb20gJ2NvbXBvbmVudC1lbWl0dGVyJztcclxuaW1wb3J0ICogYXMgV1MgZnJvbSAnd3MnO1xyXG5pbXBvcnQgeyBzZXJpYWxpemUsIGRlc2VyaWFsaXplLCBOb2RlQnVmZmVyIH0gZnJvbSAnb2JqZWN0MmJ1ZmZlcic7XHJcbmltcG9ydCB7IGRhdGFUeXBlIH0gZnJvbSAnb2JqZWN0MmJ1ZmZlci9zcmMvRGF0YVR5cGUnO1xyXG5cclxuaW1wb3J0IHsgUmVhZHlTdGF0ZSB9IGZyb20gXCIuL1JlYWR5U3RhdGVcIjtcclxuaW1wb3J0IHsgQmFzZVNvY2tldENvbmZpZyB9IGZyb20gJy4vQmFzZVNvY2tldENvbmZpZyc7XHJcbmltcG9ydCB7IFF1ZXVlRGF0YSB9IGZyb20gJy4vUXVldWVEYXRhJztcclxuXHJcbi8qKlxyXG4gKiBTb2NrZXQg5o6l5Y+j55qE5oq96LGh57G777yM5a6a5LmJ5LqGc29ja2V06ZyA6KaB5a6e546w55qE5Z+656GA5Yqf6IO9XHJcbiAqL1xyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQmFzZVNvY2tldCBleHRlbmRzIEVtaXR0ZXIge1xyXG4gICAgLyoqXHJcbiAgICAgKiBfbWVzc2FnZUlEIOeahElE5Y+377yMaWTku44w5byA5aeL44CC5q+P5Y+R5LiA5p2h5raI5oGv77yM6K+laWTliqAxXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX21lc3NhZ2VJRCA9IDA7XHJcblxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBfbmVlZERlc2VyaWFsaXplOiBib29sZWFuO1xyXG5cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX21heFBheWxvYWQ6IG51bWJlcjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOetieW+heWPkemAgea2iOaBr+eahOmYn+WIl+OAgmtlee+8mm1lc3NhZ2VJROOAglxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9xdWV1ZTogTWFwPG51bWJlciwgUXVldWVEYXRhPiA9IG5ldyBNYXAoKTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOS/neWtmOiiq+WMheijheeahHNvY2tldOWvueixoVxyXG4gICAgICovXHJcbiAgICByZWFkb25seSBfc29ja2V0OiBXZWJTb2NrZXQgfCBXUztcclxuXHJcbiAgICAvKipcclxuICAgICAqIFdlYlNvY2tldCBzZXJ2ZXIg55qEVVJM5Zyw5Z2AICAgXHJcbiAgICAgKiDms6jmhI/vvJrlpoLmnpzmmK9TZXJ2ZXLnlJ/miJDnmoRTb2NrZXTvvIzliJl1cmzkuLrnqbrlrZfnrKbkuLJcclxuICAgICAqL1xyXG4gICAgcmVhZG9ubHkgdXJsOiBzdHJpbmc7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDov57mjqXnmoTlvZPliY3nirbmgIFcclxuICAgICAqL1xyXG4gICAgZ2V0IHJlYWR5U3RhdGUoKTogUmVhZHlTdGF0ZSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NvY2tldC5yZWFkeVN0YXRlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Zyo57yT5Yay6Zif5YiX5Lit562J5b6F5Y+R6YCB55qE5pWw5o2u5a2X6IqC5pWwXHJcbiAgICAgKi9cclxuICAgIGdldCBidWZmZXJlZEFtb3VudCgpOiBudW1iZXIge1xyXG4gICAgICAgIGxldCBzaXplID0gMDtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaXRlbSBvZiB0aGlzLl9xdWV1ZS52YWx1ZXMoKSkge1xyXG4gICAgICAgICAgICBzaXplICs9IGl0ZW0uZGF0YS5sZW5ndGg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gc2l6ZTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihjb25maWdzOiBCYXNlU29ja2V0Q29uZmlnKSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuXHJcbiAgICAgICAgdGhpcy51cmwgPSBjb25maWdzLnVybDtcclxuICAgICAgICB0aGlzLl9uZWVkRGVzZXJpYWxpemUgPSBjb25maWdzLm5lZWREZXNlcmlhbGl6ZSA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6IGNvbmZpZ3MubmVlZERlc2VyaWFsaXplO1xyXG4gICAgICAgIHRoaXMuX21heFBheWxvYWQgPSBjb25maWdzLm1heFBheWxvYWQgPT09IHVuZGVmaW5lZCA/IDEwMjQgKiAxMDI0ICogMTAwIDogY29uZmlncy5tYXhQYXlsb2FkO1xyXG5cclxuICAgICAgICBpZiAoY29uZmlncy5zb2NrZXQgPT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfkvKDlhaVCYXNlU29ja2V055qEY29uZmlncy5zb2NrZXTkuI3lj6/ku6XkuLrnqbonKTtcclxuICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgIHRoaXMuX3NvY2tldCA9IGNvbmZpZ3Muc29ja2V0O1xyXG5cclxuICAgICAgICB0aGlzLm9uY2UoJ2Nsb3NlJywgKCkgPT4geyAgICAvL+WmguaenOaWreW8gO+8jOe7iOatouaJgOaciei/mOacquWPkemAgeeahOa2iOaBr1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpdGVtIG9mIFsuLi50aGlzLl9xdWV1ZS52YWx1ZXMoKV0ucmV2ZXJzZSgpKSB7IC8v5LuO5ZCO5ZCR5YmN5Y+W5raIXHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBpdGVtLmNhbmNlbChuZXcgRXJyb3IoJ+i/nuaOpeS4reaWrScpKTtcclxuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKVxyXG4gICAgICAgICAgICAgICAgICAgIGl0ZW0uYWNrKG5ldyBFcnJvcign6L+e5o6l5Lit5patJykpOyAgICAvL+WPlua2iOato+WcqOWPkemAgeeahFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDluo/liJfljJbmtojmga/lpLTpg6jjgIIgICAgXHJcbiAgICAgKiBcclxuICAgICAqIEBwcml2YXRlXHJcbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzSW50ZXJuYWwg5piv5ZCm5piv5YaF6YOo5raI5oGvXHJcbiAgICAgKiBAcGFyYW0ge2RhdGFUeXBlfSBtZXNzYWdlTmFtZSDmtojmga/nmoTlkI3np7BcclxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbmVlZEFDSyBcclxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBtZXNzYWdlSURcclxuICAgICAqIEByZXR1cm5zIHtCdWZmZXJ9IFxyXG4gICAgICogQG1lbWJlcm9mIEJhc2VTb2NrZXRcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfc2VyaWFsaXplSGVhZGVyKGlzSW50ZXJuYWw6IGJvb2xlYW4sIG1lc3NhZ2VOYW1lOiBkYXRhVHlwZSwgbmVlZEFDSzogYm9vbGVhbiwgbWVzc2FnZUlEOiBudW1iZXIpOiBCdWZmZXIge1xyXG4gICAgICAgIGNvbnN0IGhlYWRlciA9IHNlcmlhbGl6ZShbaXNJbnRlcm5hbCwgbmVlZEFDSywgbWVzc2FnZUlELCBtZXNzYWdlTmFtZV0pO1xyXG4gICAgICAgIGNvbnN0IGhlYWRlckxlbmd0aCA9IE5vZGVCdWZmZXIuYWxsb2MoOCk7XHJcbiAgICAgICAgaGVhZGVyTGVuZ3RoLndyaXRlRG91YmxlQkUoaGVhZGVyLmxlbmd0aCwgMCk7XHJcblxyXG4gICAgICAgIHJldHVybiBOb2RlQnVmZmVyLmNvbmNhdChbaGVhZGVyTGVuZ3RoLCBoZWFkZXJdKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWPjeW6j+WIl+WMluWktOmDqFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9kZXNlcmlhbGl6ZUhlYWRlcihkYXRhOiBCdWZmZXIpIHtcclxuICAgICAgICBjb25zdCBoZWFkZXJMZW5ndGggPSBkYXRhLnJlYWREb3VibGVCRSgwKTtcclxuICAgICAgICBjb25zdCBoZWFkZXIgPSBkZXNlcmlhbGl6ZShkYXRhLnNsaWNlKDgsIGhlYWRlckxlbmd0aCkpO1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBpc0ludGVybmFsOiBoZWFkZXJbMF0gYXMgYm9vbGVhbixcclxuICAgICAgICAgICAgbmVlZEFDSzogaGVhZGVyWzFdIGFzIGJvb2xlYW4sXHJcbiAgICAgICAgICAgIG1lc3NhZ2VJRDogaGVhZGVyWzJdIGFzIG51bWJlcixcclxuICAgICAgICAgICAgbWVzc2FnZU5hbWU6IGhlYWRlclszXSxcclxuICAgICAgICAgICAgaGVhZGVyTGVuZ3RoOiA4ICsgaGVhZGVyTGVuZ3RoXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWPkemAgeaVsOaNruOAguWPkemAgeWksei0peebtOaOpeaKm+WHuuW8guW4uFxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0ge2RhdGFUeXBlfSBtZXNzYWdlTmFtZSDmtojmga/nmoTlkI3np7Ao5qCH6aKYKVxyXG4gICAgICogQHBhcmFtIHtkYXRhVHlwZVtdfSBbZGF0YT1bXV0g6KaB5Y+R6YCB55qE5pWw5o2u44CC5aaC5p6c5piv5Lyg5YWl55qE5piv5pWw57uE77yM5YiZ5pWw5o2u5bCG5L2/55Sob2JqZWN0MmJ1ZmZlcui/m+ihjOW6j+WIl+WMluOAguWmguaenOS8oOWFpeeahOaYr0J1ZmZlcu+8jOWImeWwhuebtOaOpeiiq+WPkemAgeOAgijms6jmhI/vvJrkvKDlhaXnmoRCdWZmZXLlpoLmnpzkuI3mmK9vYmplY3QyYnVmZmVy5bqP5YiX5YyW5Lqn55Sf55qE77yM5YiZ6ZyA6KaB5o6l5pS25pa56K6+572ubmVlZERlc2VyaWFsaXplID0gZmFsc2UpXHJcbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtuZWVkQUNLPXRydWVdIOWPkeWHuueahOi/meadoea2iOaBr+aYr+WQpumcgOimgeehruiupOWvueaWueaYr+WQpuW3sue7j+aUtuWIsFxyXG4gICAgICogQHBhcmFtIHtib29sZWFufSBbcHJpb3I9ZmFsc2VdIOaYr+WQpuebtOaOpeWPkemAge+8iOWcqOe8k+WGsumYn+WIl+S4reaOkumYn+OAgum7mOiupGZhbHNl77yJXHJcbiAgICAgKiBAcmV0dXJucyB7KFByb21pc2U8dm9pZD4gJiB7IG1lc3NhZ2VJRDogbnVtYmVyIH0pfSBtZXNzYWdlSURcclxuICAgICAqL1xyXG4gICAgc2VuZChtZXNzYWdlTmFtZTogZGF0YVR5cGUsIGRhdGE6IGRhdGFUeXBlW10gfCBCdWZmZXIgPSBbXSwgbmVlZEFDSzogYm9vbGVhbiA9IHRydWUsIHByaW9yOiBib29sZWFuID0gZmFsc2UpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc2VuZChmYWxzZSwgcHJpb3IsIG1lc3NhZ2VOYW1lLCBuZWVkQUNLLCBkYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAgKiDlj5HpgIHlhoXpg6jmlbDmja7jgILlj5HpgIHlpLHotKXnm7TmjqXmipvlh7rlvILluLjjgILlhoXpg6jmlbDmja7pu5jorqTkuI3pnIDopoHmjqXmlLbnq6/noa7orqQg77yM5bm25LiU6buY6K6k5LyY5YWI5Y+R6YCBICAgICBcclxuICAgICAgKiDms6jmhI/vvJropoHlnKjmr4/kuIDkuKrosIPnlKjnmoTlnLDmlrnlgZrlpb3lvILluLjlpITnkIZcclxuICAgICAgKi9cclxuICAgIHByb3RlY3RlZCBfc2VuZEludGVybmFsKG1lc3NhZ2VOYW1lOiBkYXRhVHlwZSwgZGF0YTogZGF0YVR5cGVbXSB8IEJ1ZmZlciA9IFtdLCBuZWVkQUNLOiBib29sZWFuID0gZmFsc2UsIHByaW9yOiBib29sZWFuID0gdHJ1ZSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9zZW5kKHRydWUsIHByaW9yLCBtZXNzYWdlTmFtZSwgbmVlZEFDSywgZGF0YSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfc2VuZChpc0ludGVybmFsOiBib29sZWFuLCBwcmlvcjogYm9vbGVhbiwgbWVzc2FnZU5hbWU6IGRhdGFUeXBlLCBuZWVkQUNLOiBib29sZWFuLCBkYXRhOiBkYXRhVHlwZVtdIHwgQnVmZmVyKTogUHJvbWlzZTx2b2lkPiAmIHsgbWVzc2FnZUlEOiBudW1iZXIgfSB7XHJcbiAgICAgICAgY29uc3QgbXNnSUQgPSB0aGlzLl9tZXNzYWdlSUQrKztcclxuXHJcbiAgICAgICAgY29uc3QgcHJvbTogYW55ID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBoZWFkZXIgPSB0aGlzLl9zZXJpYWxpemVIZWFkZXIoaXNJbnRlcm5hbCwgbWVzc2FnZU5hbWUsIG5lZWRBQ0ssIG1zZ0lEKTtcclxuXHJcbiAgICAgICAgICAgIGxldCBzZW5kaW5nRGF0YTogQnVmZmVyOyAgICAvL+imgeWPkemAgeeahOaVsOaNrlxyXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSlcclxuICAgICAgICAgICAgICAgIHNlbmRpbmdEYXRhID0gTm9kZUJ1ZmZlci5jb25jYXQoW2hlYWRlciwgc2VyaWFsaXplKGRhdGEpXSk7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHNlbmRpbmdEYXRhID0gTm9kZUJ1ZmZlci5jb25jYXQoW2hlYWRlciwgZGF0YV0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKHNlbmRpbmdEYXRhLmxlbmd0aCA+PSB0aGlzLl9tYXhQYXlsb2FkKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+WPkemAgeeahOaVsOaNruWkp+Wwj+i2hei/h+S6humZkOWIticpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjb250cm9sOiBRdWV1ZURhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhOiBzZW5kaW5nRGF0YSxcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2VJRDogbXNnSUQsXHJcbiAgICAgICAgICAgICAgICBzZW50OiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGNhbmNlbDogKGVycikgPT4geyAgLy/ov5jmnKrlj5HpgIHkuYvliY3miY3lj6/ku6Xlj5bmtohcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY29udHJvbC5zZW50KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3F1ZXVlLmRlbGV0ZShtc2dJRCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVyciA/IHJlamVjdChlcnIpIDogcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgc2VuZDogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sLnNlbnQpIHJldHVybjsgICAvL+mBv+WFjemHjeWkjeWPkemAgVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRyb2wuc2VudCA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChuZWVkQUNLKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3NlbmREYXRhKHNlbmRpbmdEYXRhKS5jYXRjaChjb250cm9sLmFjayk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VuZERhdGEoc2VuZGluZ0RhdGEpLnRoZW4oPGFueT5jb250cm9sLmFjaykuY2F0Y2goY29udHJvbC5hY2spO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBhY2s6IChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0ZpcnN0ID0gdGhpcy5fcXVldWUudmFsdWVzKCkubmV4dCgpLnZhbHVlID09PSBjb250cm9sO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3F1ZXVlLmRlbGV0ZShtc2dJRCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXJyID8gcmVqZWN0KGVycikgOiByZXNvbHZlKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0ZpcnN0ICYmIHRoaXMuX3F1ZXVlLnNpemUgPiAwKSAgIC8v5aaC5p6c6Zif5YiX5Lit6L+Y5pyJ77yM5bm25LiU6Ieq5bex5L2N5LqO6Zif5YiX5aS06YOo77yI5Li76KaB6ZKI5a+5cHJpb3LnmoTmg4XlhrXvvInvvIzliJnlj5HpgIHkuIvkuIDmnaFcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcXVldWUudmFsdWVzKCkubmV4dCgpLnZhbHVlLnNlbmQoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX3F1ZXVlLnNldChtc2dJRCwgY29udHJvbCk7ICAgIC8v5re75Yqg5Yiw6Zif5YiX5LitXHJcblxyXG4gICAgICAgICAgICBpZiAocHJpb3IgfHwgdGhpcy5fcXVldWUuc2l6ZSA9PT0gMSkgeyAgIC8v5aaC5p6c5Y+q5pyJ5Yia5Yia6K6+572u55qE6L+Z5LiA5p2hXHJcbiAgICAgICAgICAgICAgICBjb250cm9sLnNlbmQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBwcm9tLm1lc3NhZ2VJRCA9IG1zZ0lEO1xyXG4gICAgICAgIHJldHVybiBwcm9tO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6ZyA6KaB5a2Q57G76KaG5YaZ44CC55So5LqO5Y+R6YCB5pWw5o2uXHJcbiAgICAgKiBcclxuICAgICAqIEBwcm90ZWN0ZWRcclxuICAgICAqIEBhYnN0cmFjdFxyXG4gICAgICogQHBhcmFtIHtCdWZmZXJ9IGRhdGEg6KaB5Y+R6YCB55qE5pWw5o2uXHJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTx2b2lkPn0gXHJcbiAgICAgKiBAbWVtYmVyb2YgQmFzZVNvY2tldFxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgX3NlbmREYXRhKGRhdGE6IEJ1ZmZlcik6IFByb21pc2U8dm9pZD47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDop6PmnpDmjqXmlLbliLDmlbDmja7jgILlrZDnsbvmjqXmlLbliLDmtojmga/lkI7pnIDopoHop6blj5Hov5nkuKrmlrnms5VcclxuICAgICAqIFxyXG4gICAgICogQHByb3RlY3RlZFxyXG4gICAgICogQHBhcmFtIHtCdWZmZXJ9IGRhdGEg5o6l5pS25Yiw5pWw5o2uXHJcbiAgICAgKiBAbWVtYmVyb2YgQmFzZVNvY2tldFxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgX3JlY2VpdmVEYXRhKGRhdGE6IEJ1ZmZlcikge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGhlYWRlciA9IHRoaXMuX2Rlc2VyaWFsaXplSGVhZGVyKGRhdGEpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGhlYWRlci5uZWVkQUNLKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5fc2VuZEludGVybmFsKCdhY2snLCBbaGVhZGVyLm1lc3NhZ2VJRF0pLmNhdGNoKGVyciA9PiB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyKSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoaGVhZGVyLmlzSW50ZXJuYWwpIHsgICAgLy/lpoLmnpzmjqXmlLbliLDnmoTmmK/lhoXpg6jlj5HmnaXnmoTmtojmga9cclxuICAgICAgICAgICAgICAgIGNvbnN0IGJvZHkgPSBkZXNlcmlhbGl6ZShkYXRhLnNsaWNlKGhlYWRlci5oZWFkZXJMZW5ndGgpKTtcclxuXHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGhlYWRlci5tZXNzYWdlTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Fjayc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrID0gdGhpcy5fcXVldWUuZ2V0KGJvZHlbMF0gYXMgbnVtYmVyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYm9keSA9IHRoaXMuX25lZWREZXNlcmlhbGl6ZSA/IGRlc2VyaWFsaXplKGRhdGEuc2xpY2UoaGVhZGVyLmhlYWRlckxlbmd0aCkpIDogZGF0YS5zbGljZShoZWFkZXIuaGVhZGVyTGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyAgLy/pgb/lhY3ooqvlpJblsYLnmoR0cnkgY2F0Y2jmjZXmjYnliLBcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ21lc3NhZ2UnLCBoZWFkZXIubWVzc2FnZU5hbWUsIGJvZHkpO1xyXG4gICAgICAgICAgICAgICAgfSwgMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWPlua2iOWPkemAgeOAguWmguaenOafkOadoea2iOaBr+i/mOayoeacieiiq+WPkemAgeWImeWPr+S7peiiq+WPlua2iOOAguWPlua2iOaIkOWKn+i/lOWbnnRydWXvvIzlpLHotKVmYWxzZVxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWVzc2FnZUlEIOimgeWPlua2iOWPkemAgea2iOaBr+eahG1lc3NhZ2VJRFxyXG4gICAgICogQHBhcmFtIHtFcnJvcn0gW2Vycl0g5Lyg6YCS5LiA5LiqZXJyb3LvvIzmjIfnpLrmnKzmrKHlj5HpgIHlpLHotKXnmoTljp/lm6BcclxuICAgICAqIEByZXR1cm5zIHtib29sZWFufSDlj5bmtojmiJDlip/ov5Tlm550cnVl77yM5aSx6LSlZmFsc2VcclxuICAgICAqIEBtZW1iZXJvZiBCYXNlU29ja2V0XHJcbiAgICAgKi9cclxuICAgIGNhbmNlbChtZXNzYWdlSUQ6IG51bWJlciwgZXJyPzogRXJyb3IpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zdCBjb250cm9sID0gdGhpcy5fcXVldWUuZ2V0KG1lc3NhZ2VJRCk7XHJcblxyXG4gICAgICAgIGlmIChjb250cm9sKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjb250cm9sLmNhbmNlbChlcnIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5YWz6Zet5o6l5Y+j44CC5YWz6Zet5LmL5ZCO5Lya6Kem5Y+RY2xvc2Xkuovku7ZcclxuICAgICAqIFxyXG4gICAgICogQGFic3RyYWN0XHJcbiAgICAgKiBAcmV0dXJucyB7dm9pZH0gXHJcbiAgICAgKiBAbWVtYmVyb2YgQmFzZVNvY2tldFxyXG4gICAgICovXHJcbiAgICBhYnN0cmFjdCBjbG9zZSgpOiB2b2lkO1xyXG5cclxuICAgIG9uKGV2ZW50OiAnZXJyb3InLCBsaXN0ZW5lcjogKGVycjogRXJyb3IpID0+IHZvaWQpOiB0aGlzXHJcbiAgICAvKipcclxuICAgICAqIOW9k+aUtuWIsOa2iOaBr1xyXG4gICAgICovXHJcbiAgICBvbihldmVudDogJ21lc3NhZ2UnLCBsaXN0ZW5lcjogKG1lc3NhZ2VOYW1lOiBzdHJpbmcsIGRhdGE6IGFueVtdIHwgQnVmZmVyKSA9PiB2b2lkKTogdGhpc1xyXG4gICAgLyoqXHJcbiAgICAgKiDlvZPov57mjqXlu7rnq4tcclxuICAgICAqL1xyXG4gICAgb24oZXZlbnQ6ICdvcGVuJywgbGlzdGVuZXI6ICgpID0+IHZvaWQpOiB0aGlzXHJcbiAgICAvKipcclxuICAgICAqIOaWreW8gOi/nuaOpVxyXG4gICAgICovXHJcbiAgICBvbihldmVudDogJ2Nsb3NlJywgbGlzdGVuZXI6IChjb2RlOiBudW1iZXIsIHJlYXNvbjogc3RyaW5nKSA9PiB2b2lkKTogdGhpc1xyXG4gICAgb24oZXZlbnQ6IHN0cmluZywgbGlzdGVuZXI6IEZ1bmN0aW9uKTogdGhpcyB7XHJcbiAgICAgICAgc3VwZXIub24oZXZlbnQsIGxpc3RlbmVyKTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICBvbmNlKGV2ZW50OiAnZXJyb3InLCBsaXN0ZW5lcjogKGVycjogRXJyb3IpID0+IHZvaWQpOiB0aGlzXHJcbiAgICBvbmNlKGV2ZW50OiAnbWVzc2FnZScsIGxpc3RlbmVyOiAobWVzc2FnZU5hbWU6IHN0cmluZywgZGF0YTogYW55W10gfCBCdWZmZXIpID0+IHZvaWQpOiB0aGlzXHJcbiAgICBvbmNlKGV2ZW50OiAnb3BlbicsIGxpc3RlbmVyOiAoKSA9PiB2b2lkKTogdGhpc1xyXG4gICAgb25jZShldmVudDogJ2Nsb3NlJywgbGlzdGVuZXI6IChjb2RlOiBudW1iZXIsIHJlYXNvbjogc3RyaW5nKSA9PiB2b2lkKTogdGhpc1xyXG4gICAgb25jZShldmVudDogc3RyaW5nLCBsaXN0ZW5lcjogRnVuY3Rpb24pOiB0aGlzIHtcclxuICAgICAgICBzdXBlci5vbmNlKGV2ZW50LCBsaXN0ZW5lcik7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcbn0iXX0=
