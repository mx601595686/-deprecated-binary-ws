"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const WS = require("ws");
const Emitter = require("component-emitter");
const http = require("http");
const https = require("https");
const Socket_1 = require("./Socket");
class Server extends Emitter {
    constructor(...args) {
        super();
        /**
         * 保存所有客户端连接。key是socket.id
         */
        this.clients = new Map();
        const config = {
            host: '0.0.0.0',
            port: 8080,
            needDeserialize: true,
            maxPayload: 1024 * 1024 * 100,
            verifyClient: (info, cb) => {
                this.verifyClient(info.req, info.origin, info.secure).then((result => {
                    if (typeof result === 'boolean') {
                        cb(result);
                    }
                    else {
                        cb(result.res, result.code, result.message);
                    }
                }));
            }
        };
        if (args[0] instanceof http.Server || args[0] instanceof https.Server) {
            config.server = args[0];
        }
        else if (typeof args[0] === 'number') {
            config.port = args[0];
        }
        else if (typeof args[0] === 'string') {
            config.host = args[0];
            if (typeof args[1] === 'number')
                config.port = args[1];
        }
        else if (typeof args[0] === 'object') {
            Object.assign(config, args[0]);
        }
        if (config.server) {
            config.host = undefined; //必须清除，否则WS内部会另外创建一个http server
            config.port = undefined;
        }
        this.ws = new WS.Server(config);
        this.ws.on('error', this.emit.bind(this, 'error'));
        this.ws.once('listening', this.emit.bind(this, 'listening'));
        this.ws._server.once('close', this.emit.bind(this, 'close')); //ws内部会把创建或绑定的http server 保存到_server中
        this.ws.on('connection', (client) => {
            const socket = new Socket_1.Socket({ url: '', socket: client, needDeserialize: config.needDeserialize, maxPayload: config.maxPayload });
            this.clients.set(socket.id, socket);
            socket.once('close', () => {
                this.clients.delete(socket.id);
            });
            socket.once('error', () => {
                socket.close();
            });
            this.emit('connection', socket);
        });
    }
    /**
     * 判断是否接受新的连接。
     * 返回true表示接受，返回false表示拒绝。也可以返回一个对象，提供更多信息。
     *
     * 返回对象：
     *      res {Boolean} Whether or not to accept the handshake.
     *      code {Number} When result is false this field determines the HTTP error status code to be sent to the client.
     *      name {String} When result is false this field determines the HTTP reason phrase.
     *
     * @param {string} origin The value in the Origin header indicated by the client.
     * @param {boolean} secure 'true' if req.connection.authorized or req.connection.encrypted is set.
     * @param {http.IncomingMessage} req The client HTTP GET request.
     * @returns {Promise<boolean | { res: boolean, code?: number, message?: string }>}
     */
    verifyClient(req, origin, secure) {
        return Promise.resolve(true);
    }
    /**
     * 关闭服务器，并断开所有的客户端连接
     */
    close() {
        const server = this.ws._server;
        this.ws.close();
        server.close(); //ws不会吧绑定的server关掉，所以这里再次关闭一下
    }
    on(event, listener) {
        super.on(event, listener);
        return this;
    }
    once(event, listener) {
        super.once(event, listener);
        return this;
    }
}
exports.Server = Server;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0QsTUFBTSxNQUFNLEdBQVMsSUFBSSxDQUFDLEVBQUcsQ0FBQyxPQUFPLENBQUM7UUFDdEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNoQixNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBSyw2QkFBNkI7SUFDckQsQ0FBQztJQVlELEVBQUUsQ0FBQyxLQUFhLEVBQUUsUUFBa0I7UUFDaEMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNoQixDQUFDO0lBTUQsSUFBSSxDQUFDLEtBQWEsRUFBRSxRQUFrQjtRQUNsQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztRQUM1QixNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSjtBQXBKRCx3QkFvSkMiLCJmaWxlIjoic2VydmVyL1NlcnZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFdTIGZyb20gJ3dzJztcclxuaW1wb3J0ICogYXMgRW1pdHRlciBmcm9tICdjb21wb25lbnQtZW1pdHRlcic7XHJcbmltcG9ydCAqIGFzIGh0dHAgZnJvbSAnaHR0cCc7XHJcbmltcG9ydCAqIGFzIGh0dHBzIGZyb20gJ2h0dHBzJztcclxuaW1wb3J0IHsgU2VydmVyQ29uZmlnIH0gZnJvbSAnLi9TZXJ2ZXJDb25maWcnO1xyXG5pbXBvcnQgeyBTb2NrZXQgfSBmcm9tICcuL1NvY2tldCc7XHJcblxyXG5leHBvcnQgY2xhc3MgU2VydmVyIGV4dGVuZHMgRW1pdHRlciB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDooqvljIXoo4XnmoR3ZWJzb2NrZXTlr7nosaFcclxuICAgICAqL1xyXG4gICAgcmVhZG9ubHkgd3M6IFdTLlNlcnZlcjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOS/neWtmOaJgOacieWuouaIt+err+i/nuaOpeOAgmtleeaYr3NvY2tldC5pZFxyXG4gICAgICovXHJcbiAgICByZWFkb25seSBjbGllbnRzOiBNYXA8bnVtYmVyLCBTb2NrZXQ+ID0gbmV3IE1hcCgpO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yib5bu6d2Vic29ja2V05pyN5Yqh5Zmo44CCXHJcbiAgICAgKi9cclxuICAgIGNvbnN0cnVjdG9yKClcclxuICAgIC8qKlxyXG4gICAgICog5Yib5bu6d2Vic29ja2V05pyN5Yqh5Zmo44CCXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaG9zdCDnm5HlkKznmoTkuLvmnLrlnLDlnYBcclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3IoaG9zdDogc3RyaW5nKVxyXG4gICAgLyoqXHJcbiAgICAgKiDliJvlu7p3ZWJzb2NrZXTmnI3liqHlmajjgIJcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwb3J0IOebkeWQrOeahOerr+WPo1xyXG4gICAgICovXHJcbiAgICBjb25zdHJ1Y3Rvcihwb3J0OiBudW1iZXIpXHJcbiAgICAvKipcclxuICAgICAqIOWIm+W7undlYnNvY2tldOacjeWKoeWZqOOAglxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGhvc3Qg55uR5ZCs55qE5Li75py65Zyw5Z2AXHJcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gcG9ydCDnm5HlkKznmoTnq6/lj6NcclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3IoaG9zdDogc3RyaW5nLCBwb3J0OiBudW1iZXIpXHJcbiAgICAvKipcclxuICAgICAqIOWIm+W7undlYnNvY2tldOacjeWKoeWZqOOAglxyXG4gICAgICogQHBhcmFtIHsoaHR0cC5TZXJ2ZXIgfCBodHRwcy5TZXJ2ZXIpfSBzZXJ2ZXIg57uR5a6a5Yiw5oyH5a6a55qEaHR0cOacjeWKoeWZqOS5i+S4ilxyXG4gICAgICovXHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2ZXI6IGh0dHAuU2VydmVyIHwgaHR0cHMuU2VydmVyKVxyXG4gICAgLyoqXHJcbiAgICAgKiDliJvlu7p3ZWJzb2NrZXTmnI3liqHlmajjgIJcclxuICAgICAqIEBwYXJhbSB7U2VydmVyQ29uZmlnfSBvcHRpb25zIOacjeWKoeWZqOmFjee9rlxyXG4gICAgICovXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBTZXJ2ZXJDb25maWcpXHJcbiAgICBjb25zdHJ1Y3RvciguLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbmZpZzogU2VydmVyQ29uZmlnICYgeyB2ZXJpZnlDbGllbnQ6IFdTLlZlcmlmeUNsaWVudENhbGxiYWNrQXN5bmMgfSA9IHtcclxuICAgICAgICAgICAgaG9zdDogJzAuMC4wLjAnLFxyXG4gICAgICAgICAgICBwb3J0OiA4MDgwLFxyXG4gICAgICAgICAgICBuZWVkRGVzZXJpYWxpemU6IHRydWUsXHJcbiAgICAgICAgICAgIG1heFBheWxvYWQ6IDEwMjQgKiAxMDI0ICogMTAwLFxyXG4gICAgICAgICAgICB2ZXJpZnlDbGllbnQ6IChpbmZvLCBjYikgPT4geyAgIC8v5bu656uL6L+e5o6l5YmN6aqM6K+BXHJcbiAgICAgICAgICAgICAgICB0aGlzLnZlcmlmeUNsaWVudChpbmZvLnJlcSwgaW5mby5vcmlnaW4sIGluZm8uc2VjdXJlKS50aGVuKChyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVzdWx0ID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2IocmVzdWx0KTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYihyZXN1bHQucmVzLCByZXN1bHQuY29kZSwgcmVzdWx0Lm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmIChhcmdzWzBdIGluc3RhbmNlb2YgKDxhbnk+aHR0cCkuU2VydmVyIHx8IGFyZ3NbMF0gaW5zdGFuY2VvZiAoPGFueT5odHRwcykuU2VydmVyKSB7XHJcbiAgICAgICAgICAgIGNvbmZpZy5zZXJ2ZXIgPSBhcmdzWzBdO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgIGNvbmZpZy5wb3J0ID0gYXJnc1swXTtcclxuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmdzWzBdID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICBjb25maWcuaG9zdCA9IGFyZ3NbMF07XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJnc1sxXSA9PT0gJ251bWJlcicpXHJcbiAgICAgICAgICAgICAgICBjb25maWcucG9ydCA9IGFyZ3NbMV07XHJcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnc1swXSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihjb25maWcsIGFyZ3NbMF0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGNvbmZpZy5zZXJ2ZXIpIHtcclxuICAgICAgICAgICAgY29uZmlnLmhvc3QgPSB1bmRlZmluZWQ7ICAgIC8v5b+F6aG75riF6Zmk77yM5ZCm5YiZV1PlhoXpg6jkvJrlj6blpJbliJvlu7rkuIDkuKpodHRwIHNlcnZlclxyXG4gICAgICAgICAgICBjb25maWcucG9ydCA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMud3MgPSBuZXcgV1MuU2VydmVyKGNvbmZpZyk7XHJcbiAgICAgICAgdGhpcy53cy5vbignZXJyb3InLCB0aGlzLmVtaXQuYmluZCh0aGlzLCAnZXJyb3InKSk7XHJcbiAgICAgICAgdGhpcy53cy5vbmNlKCdsaXN0ZW5pbmcnLCB0aGlzLmVtaXQuYmluZCh0aGlzLCAnbGlzdGVuaW5nJykpO1xyXG4gICAgICAgICg8YW55PnRoaXMud3MpLl9zZXJ2ZXIub25jZSgnY2xvc2UnLCB0aGlzLmVtaXQuYmluZCh0aGlzLCAnY2xvc2UnKSk7ICAvL3dz5YaF6YOo5Lya5oqK5Yib5bu65oiW57uR5a6a55qEaHR0cCBzZXJ2ZXIg5L+d5a2Y5YiwX3NlcnZlcuS4rVxyXG4gICAgICAgIHRoaXMud3Mub24oJ2Nvbm5lY3Rpb24nLCAoY2xpZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNvY2tldCA9IG5ldyBTb2NrZXQoeyB1cmw6ICcnLCBzb2NrZXQ6IGNsaWVudCwgbmVlZERlc2VyaWFsaXplOiBjb25maWcubmVlZERlc2VyaWFsaXplLCBtYXhQYXlsb2FkOiBjb25maWcubWF4UGF5bG9hZCB9KTtcclxuICAgICAgICAgICAgdGhpcy5jbGllbnRzLnNldChzb2NrZXQuaWQsIHNvY2tldCk7XHJcblxyXG4gICAgICAgICAgICBzb2NrZXQub25jZSgnY2xvc2UnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsaWVudHMuZGVsZXRlKHNvY2tldC5pZCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgc29ja2V0Lm9uY2UoJ2Vycm9yJywgKCkgPT4geyAgICAvL+aOpeWPo+WmguaenOWHuueOsOW8guW4uOWImeWFs+mXrVxyXG4gICAgICAgICAgICAgICAgc29ja2V0LmNsb3NlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5lbWl0KCdjb25uZWN0aW9uJywgc29ja2V0KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIpOaWreaYr+WQpuaOpeWPl+aWsOeahOi/nuaOpeOAgiAgICBcclxuICAgICAqIOi/lOWbnnRydWXooajnpLrmjqXlj5fvvIzov5Tlm55mYWxzZeihqOekuuaLkue7neOAguS5n+WPr+S7pei/lOWbnuS4gOS4quWvueixoe+8jOaPkOS+m+abtOWkmuS/oeaBr+OAgiAgXHJcbiAgICAgKiAgXHJcbiAgICAgKiDov5Tlm57lr7nosaHvvJogICAgXHJcbiAgICAgKiAgICAgIHJlcyB7Qm9vbGVhbn0gV2hldGhlciBvciBub3QgdG8gYWNjZXB0IHRoZSBoYW5kc2hha2UuICAgXHJcbiAgICAgKiAgICAgIGNvZGUge051bWJlcn0gV2hlbiByZXN1bHQgaXMgZmFsc2UgdGhpcyBmaWVsZCBkZXRlcm1pbmVzIHRoZSBIVFRQIGVycm9yIHN0YXR1cyBjb2RlIHRvIGJlIHNlbnQgdG8gdGhlIGNsaWVudC4gICBcclxuICAgICAqICAgICAgbmFtZSB7U3RyaW5nfSBXaGVuIHJlc3VsdCBpcyBmYWxzZSB0aGlzIGZpZWxkIGRldGVybWluZXMgdGhlIEhUVFAgcmVhc29uIHBocmFzZS4gICBcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG9yaWdpbiBUaGUgdmFsdWUgaW4gdGhlIE9yaWdpbiBoZWFkZXIgaW5kaWNhdGVkIGJ5IHRoZSBjbGllbnQuXHJcbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNlY3VyZSAndHJ1ZScgaWYgcmVxLmNvbm5lY3Rpb24uYXV0aG9yaXplZCBvciByZXEuY29ubmVjdGlvbi5lbmNyeXB0ZWQgaXMgc2V0LlxyXG4gICAgICogQHBhcmFtIHtodHRwLkluY29taW5nTWVzc2FnZX0gcmVxIFRoZSBjbGllbnQgSFRUUCBHRVQgcmVxdWVzdC5cclxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4gfCB7IHJlczogYm9vbGVhbiwgY29kZT86IG51bWJlciwgbWVzc2FnZT86IHN0cmluZyB9Pn0gXHJcbiAgICAgKi9cclxuICAgIHZlcmlmeUNsaWVudChyZXE6IGh0dHAuSW5jb21pbmdNZXNzYWdlLCBvcmlnaW46IHN0cmluZywgc2VjdXJlOiBib29sZWFuKTogUHJvbWlzZTxib29sZWFuIHwgeyByZXM6IGJvb2xlYW4sIGNvZGU/OiBudW1iZXIsIG1lc3NhZ2U/OiBzdHJpbmcgfT4ge1xyXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlhbPpl63mnI3liqHlmajvvIzlubbmlq3lvIDmiYDmnInnmoTlrqLmiLfnq6/ov57mjqVcclxuICAgICAqL1xyXG4gICAgY2xvc2UoKSB7XHJcbiAgICAgICAgY29uc3Qgc2VydmVyID0gKDxhbnk+dGhpcy53cykuX3NlcnZlcjtcclxuICAgICAgICB0aGlzLndzLmNsb3NlKCk7XHJcbiAgICAgICAgc2VydmVyLmNsb3NlKCk7ICAgICAvL3dz5LiN5Lya5ZCn57uR5a6a55qEc2VydmVy5YWz5o6J77yM5omA5Lul6L+Z6YeM5YaN5qyh5YWz6Zet5LiA5LiLXHJcbiAgICB9XHJcblxyXG4gICAgb24oZXZlbnQ6ICdlcnJvcicsIGxpc3RlbmVyOiAoZXJyOiBFcnJvcikgPT4gdm9pZCk6IHRoaXNcclxuICAgIC8qKlxyXG4gICAgICog5b2T5pyN5Yqh5Zmo5byA5aeL55uR5ZCsXHJcbiAgICAgKi9cclxuICAgIG9uKGV2ZW50OiAnbGlzdGVuaW5nJywgbGlzdGVuZXI6ICgpID0+IHZvaWQpOiB0aGlzXHJcbiAgICAvKipcclxuICAgICAqIOW9k+acieaWsOeahOWuouaIt+err+S4juacjeWKoeWZqOW7uueri+i1t+i/nuaOpVxyXG4gICAgICovXHJcbiAgICBvbihldmVudDogJ2Nvbm5lY3Rpb24nLCBsaXN0ZW5lcjogKHNvY2tldDogU29ja2V0KSA9PiB2b2lkKTogdGhpc1xyXG4gICAgb24oZXZlbnQ6ICdjbG9zZScsIGxpc3RlbmVyOiAoZXJyOiBFcnJvcikgPT4gdm9pZCk6IHRoaXNcclxuICAgIG9uKGV2ZW50OiBzdHJpbmcsIGxpc3RlbmVyOiBGdW5jdGlvbik6IHRoaXMge1xyXG4gICAgICAgIHN1cGVyLm9uKGV2ZW50LCBsaXN0ZW5lcik7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgb25jZShldmVudDogJ2Vycm9yJywgbGlzdGVuZXI6IChlcnI6IEVycm9yKSA9PiB2b2lkKTogdGhpc1xyXG4gICAgb25jZShldmVudDogJ2xpc3RlbmluZycsIGxpc3RlbmVyOiAoKSA9PiB2b2lkKTogdGhpc1xyXG4gICAgb25jZShldmVudDogJ2Nvbm5lY3Rpb24nLCBsaXN0ZW5lcjogKHNvY2tldDogU29ja2V0KSA9PiB2b2lkKTogdGhpc1xyXG4gICAgb25jZShldmVudDogJ2Nsb3NlJywgbGlzdGVuZXI6IChlcnI6IEVycm9yKSA9PiB2b2lkKTogdGhpc1xyXG4gICAgb25jZShldmVudDogc3RyaW5nLCBsaXN0ZW5lcjogRnVuY3Rpb24pOiB0aGlzIHtcclxuICAgICAgICBzdXBlci5vbmNlKGV2ZW50LCBsaXN0ZW5lcik7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcbn0iXX0=
