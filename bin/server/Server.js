"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const WS = require("ws");
const Emitter = require("component-emitter");
const http = require("http");
const https = require("https");
const Socket_1 = require("./../common/Socket");
class Server extends Emitter {
    constructor(...args) {
        super();
        /**
         * 保存所有客户端连接。key是socket.id
         */
        this.clients = new Map();
        const config = {
            host: '0.0.0.0',
            port: 8080,
            maxPayload: 1024 * 1024 * 10,
            verifyClient: (info, cb) => {
                this.verifyClient(info.req, info.origin, info.secure).then(cb);
            },
            clientTracking: false,
        };
        if (args[0] instanceof http.Server || args[0] instanceof https.Server) {
            config.server = args[0];
        }
        else if (typeof args[0] === 'string') {
            config.host = args[0];
            if (typeof args[1] === 'number')
                config.port = args[1];
        }
        else if (typeof args[0] === 'object') {
            Object.assign(config, args[0]);
            config.maxPayload = config.maxPayload < 1024 ? 1024 : config.maxPayload;
        }
        this._ws = new WS.Server(config);
        this._ws.on('error', this.emit.bind(this, 'error'));
        this._ws.on('listening', this.emit.bind(this, 'error'));
        this._ws.on('connection', (client) => {
            const socket = new Socket_1.Socket(client);
            this.onConnection(socket);
            this.clients.set(socket.id, socket);
            socket.on('close', () => {
                this.clients.delete(socket.id);
            });
        });
    }
    /**
     * 判断是否接受新的连接
     *
     * @param {string} origin The value in the Origin header indicated by the client.
     * @param {boolean} secure 'true' if req.connection.authorized or req.connection.encrypted is set.
     * @param {http.IncomingMessage} req The client HTTP GET request.
     * @returns {Promise<boolean>}
     * @memberof Server
     */
    verifyClient(req, origin, secure) {
        return Promise.resolve(true);
    }
    /**
     * 当有新的客户端与服务器建立起连接
     *
     * @param {Socket} socket 接口
     * @memberof Server
     */
    onConnection(socket) { }
    /**
     * 关闭服务器，并断开所有的客户端连接
     *
     * @returns {Promise<void>}
     * @memberof Server
     */
    close() {
        return new Promise((resolve, reject) => {
            this._ws.close(err => {
                err ? reject(err) : resolve();
            });
        });
    }
    on(event, listener) {
        super.on(event, listener);
        return this;
    }
}
exports.Server = Server;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxFQUFFLENBQUMsQ0FBQztZQUNuQyxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVEOzs7Ozs7OztPQVFHO0lBQ0gsWUFBWSxDQUFDLEdBQXlCLEVBQUUsTUFBYyxFQUFFLE1BQWU7UUFDbkUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsWUFBWSxDQUFDLE1BQWMsSUFBSSxDQUFDO0lBRWhDOzs7OztPQUtHO0lBQ0gsS0FBSztRQUNELE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNO1lBQy9CLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUc7Z0JBQ2QsR0FBRyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLEVBQUUsQ0FBQztZQUNsQyxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQVFELEVBQUUsQ0FBQyxLQUFhLEVBQUUsUUFBa0I7UUFDaEMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNoQixDQUFDO0NBQ0o7QUFySUQsd0JBcUlDIiwiZmlsZSI6InNlcnZlci9TZXJ2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBXUyBmcm9tICd3cyc7XHJcbmltcG9ydCAqIGFzIEVtaXR0ZXIgZnJvbSAnY29tcG9uZW50LWVtaXR0ZXInO1xyXG5pbXBvcnQgKiBhcyBodHRwIGZyb20gJ2h0dHAnO1xyXG5pbXBvcnQgKiBhcyBodHRwcyBmcm9tICdodHRwcyc7XHJcbmltcG9ydCB7IFNlcnZlckNvbmZpZyB9IGZyb20gJy4vU2VydmVyQ29uZmlnJztcclxuaW1wb3J0IHsgU29ja2V0IH0gZnJvbSAnLi8uLi9jb21tb24vU29ja2V0JztcclxuXHJcbmV4cG9ydCBjbGFzcyBTZXJ2ZXIgZXh0ZW5kcyBFbWl0dGVyIHtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWOn+Wni+eahHdlYnNvY2tldOWvueixoVxyXG4gICAgICogXHJcbiAgICAgKiBAdHlwZSB7V1MuU2VydmVyfVxyXG4gICAgICogQG1lbWJlcm9mIFNlcnZlclxyXG4gICAgICovXHJcbiAgICByZWFkb25seSBfd3M6IFdTLlNlcnZlcjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOS/neWtmOaJgOacieWuouaIt+err+i/nuaOpeOAgmtleeaYr3NvY2tldC5pZFxyXG4gICAgICovXHJcbiAgICByZWFkb25seSBjbGllbnRzOiBNYXA8c3RyaW5nLCBTb2NrZXQ+ID0gbmV3IE1hcCgpO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yib5bu6d2Vic29ja2V05pyN5Yqh5Zmo44CCXHJcbiAgICAgKiBAbWVtYmVyb2YgU2VydmVyXHJcbiAgICAgKi9cclxuICAgIGNvbnN0cnVjdG9yKClcclxuICAgIC8qKlxyXG4gICAgICog5Yib5bu6d2Vic29ja2V05pyN5Yqh5Zmo44CCXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaG9zdCDnm5HlkKznmoTlnLDlnYBcclxuICAgICAqIEBtZW1iZXJvZiBTZXJ2ZXJcclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3IoaG9zdDogc3RyaW5nKVxyXG4gICAgLyoqXHJcbiAgICAgKiDliJvlu7p3ZWJzb2NrZXTmnI3liqHlmajjgIJcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwb3J0IOebkeWQrOeahOerr+WPo1xyXG4gICAgICogQG1lbWJlcm9mIFNlcnZlclxyXG4gICAgICovXHJcbiAgICBjb25zdHJ1Y3Rvcihwb3J0OiBudW1iZXIpXHJcbiAgICAvKipcclxuICAgICAqIOWIm+W7undlYnNvY2tldOacjeWKoeWZqOOAglxyXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGhvc3Qg55uR5ZCs55qE5Zyw5Z2AXHJcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gcG9ydCDnm5HlkKznmoTnq6/lj6NcclxuICAgICAqIEBtZW1iZXJvZiBTZXJ2ZXJcclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3IoaG9zdDogc3RyaW5nLCBwb3J0OiBudW1iZXIpXHJcbiAgICAvKipcclxuICAgICAqIOWIm+W7undlYnNvY2tldOacjeWKoeWZqOOAglxyXG4gICAgICogQHBhcmFtIHsoaHR0cC5TZXJ2ZXIgfCBodHRwcy5TZXJ2ZXIpfSBzZXJ2ZXIg57uR5a6a5Yiw6L+Z5LiqaHR0cOacjeWKoeWZqOS5i+S4ilxyXG4gICAgICogQG1lbWJlcm9mIFNlcnZlclxyXG4gICAgICovXHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2ZXI6IGh0dHAuU2VydmVyIHwgaHR0cHMuU2VydmVyKVxyXG4gICAgLyoqXHJcbiAgICAgKiDliJvlu7p3ZWJzb2NrZXTmnI3liqHlmajjgIJcclxuICAgICAqIEBwYXJhbSB7U2VydmVyQ29uZmlnfSBvcHRpb25zIOacjeWKoeWZqOmFjee9rlxyXG4gICAgICogQG1lbWJlcm9mIFNlcnZlclxyXG4gICAgICovXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBTZXJ2ZXJDb25maWcpXHJcbiAgICBjb25zdHJ1Y3RvciguLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbmZpZzogU2VydmVyQ29uZmlnIHwgYW55ID0ge1xyXG4gICAgICAgICAgICBob3N0OiAnMC4wLjAuMCcsXHJcbiAgICAgICAgICAgIHBvcnQ6IDgwODAsXHJcbiAgICAgICAgICAgIG1heFBheWxvYWQ6IDEwMjQgKiAxMDI0ICogMTAsXHJcbiAgICAgICAgICAgIHZlcmlmeUNsaWVudDogKGluZm86IGFueSwgY2I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy52ZXJpZnlDbGllbnQoaW5mby5yZXEsIGluZm8ub3JpZ2luLCBpbmZvLnNlY3VyZSkudGhlbihjYik7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGNsaWVudFRyYWNraW5nOiBmYWxzZSwgIC8vV1PkuI3lnKhzZXJ2ZXIuY2xpZW50c+S4reS/neWtmOWuouaIt+err+i/nuaOpVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmIChhcmdzWzBdIGluc3RhbmNlb2YgKDxhbnk+aHR0cCkuU2VydmVyIHx8IGFyZ3NbMF0gaW5zdGFuY2VvZiAoPGFueT5odHRwcykuU2VydmVyKSB7XHJcbiAgICAgICAgICAgIGNvbmZpZy5zZXJ2ZXIgPSBhcmdzWzBdO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgIGNvbmZpZy5ob3N0ID0gYXJnc1swXTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmdzWzFdID09PSAnbnVtYmVyJylcclxuICAgICAgICAgICAgICAgIGNvbmZpZy5wb3J0ID0gYXJnc1sxXTtcclxuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmdzWzBdID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGNvbmZpZywgYXJnc1swXSk7XHJcbiAgICAgICAgICAgIGNvbmZpZy5tYXhQYXlsb2FkID0gY29uZmlnLm1heFBheWxvYWQgPCAxMDI0ID8gMTAyNCA6IGNvbmZpZy5tYXhQYXlsb2FkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fd3MgPSBuZXcgV1MuU2VydmVyKGNvbmZpZyk7XHJcbiAgICAgICAgdGhpcy5fd3Mub24oJ2Vycm9yJywgdGhpcy5lbWl0LmJpbmQodGhpcywgJ2Vycm9yJykpO1xyXG4gICAgICAgIHRoaXMuX3dzLm9uKCdsaXN0ZW5pbmcnLCB0aGlzLmVtaXQuYmluZCh0aGlzLCAnZXJyb3InKSk7XHJcbiAgICAgICAgdGhpcy5fd3Mub24oJ2Nvbm5lY3Rpb24nLCAoY2xpZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNvY2tldCA9IG5ldyBTb2NrZXQoY2xpZW50KTtcclxuICAgICAgICAgICAgdGhpcy5vbkNvbm5lY3Rpb24oc29ja2V0KTtcclxuICAgICAgICAgICAgdGhpcy5jbGllbnRzLnNldChzb2NrZXQuaWQsIHNvY2tldCk7XHJcbiAgICAgICAgICAgIHNvY2tldC5vbignY2xvc2UnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsaWVudHMuZGVsZXRlKHNvY2tldC5pZCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yik5pat5piv5ZCm5o6l5Y+X5paw55qE6L+e5o6lXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBvcmlnaW4gVGhlIHZhbHVlIGluIHRoZSBPcmlnaW4gaGVhZGVyIGluZGljYXRlZCBieSB0aGUgY2xpZW50LlxyXG4gICAgICogQHBhcmFtIHtib29sZWFufSBzZWN1cmUgJ3RydWUnIGlmIHJlcS5jb25uZWN0aW9uLmF1dGhvcml6ZWQgb3IgcmVxLmNvbm5lY3Rpb24uZW5jcnlwdGVkIGlzIHNldC5cclxuICAgICAqIEBwYXJhbSB7aHR0cC5JbmNvbWluZ01lc3NhZ2V9IHJlcSBUaGUgY2xpZW50IEhUVFAgR0VUIHJlcXVlc3QuXHJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxib29sZWFuPn0gXHJcbiAgICAgKiBAbWVtYmVyb2YgU2VydmVyXHJcbiAgICAgKi9cclxuICAgIHZlcmlmeUNsaWVudChyZXE6IGh0dHAuSW5jb21pbmdNZXNzYWdlLCBvcmlnaW46IHN0cmluZywgc2VjdXJlOiBib29sZWFuKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOW9k+acieaWsOeahOWuouaIt+err+S4juacjeWKoeWZqOW7uueri+i1t+i/nuaOpVxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0ge1NvY2tldH0gc29ja2V0IOaOpeWPo1xyXG4gICAgICogQG1lbWJlcm9mIFNlcnZlclxyXG4gICAgICovXHJcbiAgICBvbkNvbm5lY3Rpb24oc29ja2V0OiBTb2NrZXQpIHsgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5YWz6Zet5pyN5Yqh5Zmo77yM5bm25pat5byA5omA5pyJ55qE5a6i5oi356uv6L+e5o6lXHJcbiAgICAgKiBcclxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPHZvaWQ+fSBcclxuICAgICAqIEBtZW1iZXJvZiBTZXJ2ZXJcclxuICAgICAqL1xyXG4gICAgY2xvc2UoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5fd3MuY2xvc2UoZXJyID0+IHtcclxuICAgICAgICAgICAgICAgIGVyciA/IHJlamVjdChlcnIpIDogcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBvbihldmVudDogJ2Vycm9yJywgY2I6IChlcnI6IEVycm9yKSA9PiB2b2lkKTogdGhpc1xyXG4gICAgLyoqXHJcbiAgICAgKiDlvZPmnI3liqHlmajlvIDlp4vnm5HlkKxcclxuICAgICAqL1xyXG4gICAgb24oZXZlbnQ6ICdsaXN0ZW5pbmcnLCBjYjogKCkgPT4gdm9pZCk6IHRoaXNcclxuICAgIG9uKGV2ZW50OiAnY2xvc2UnLCBjYjogKGVycjogRXJyb3IpID0+IHZvaWQpOiB0aGlzXHJcbiAgICBvbihldmVudDogc3RyaW5nLCBsaXN0ZW5lcjogRnVuY3Rpb24pOiB0aGlzIHtcclxuICAgICAgICBzdXBlci5vbihldmVudCwgbGlzdGVuZXIpO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG59Il19
