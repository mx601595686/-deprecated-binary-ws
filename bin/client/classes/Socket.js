"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const BaseSocket_1 = require("../../BaseSocket/classes/BaseSocket");
if (!require('is-node'))
    Buffer = require('buffer/').Buffer;
const nodeBufferToArraybuffer = require('to-arraybuffer');
class Socket extends BaseSocket_1.BaseSocket {
    constructor(configs = { url: `ws${location.protocol === 'https:' ? 's' : ''}://${location.host}` }) {
        super(new WebSocket(configs.url), configs);
        this._socket.binaryType = 'arraybuffer';
        this._socket.onopen = () => this.emit('open');
        this._socket.onclose = (ev) => this.emit('close', ev.code, ev.reason);
        this._socket.onerror = (err) => { console.error(err), this.emit('error', new Error('连接异常')); };
        this._socket.onmessage = (e) => this._receiveData(Buffer.from(e.data));
    }
    _sendData(data) {
        return new Promise((resolve, reject) => {
            this._socket.send(nodeBufferToArraybuffer(data)); //不可以直接发送buffer
            const check = (interval) => {
                setTimeout(() => {
                    if (this._socket.bufferedAmount === 0) {
                        resolve();
                    }
                    else {
                        check(interval >= 2000 ? 2000 : interval * 2); //最慢2秒检查一次
                    }
                }, interval);
            };
            check(1);
        });
    }
    close() {
        this._socket.close();
    }
}
exports.Socket = Socket;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsaWVudC9jbGFzc2VzL1NvY2tldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9FQUFpRTtBQUdqRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDO0FBQzVELE1BQU0sdUJBQXVCLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFFMUQsWUFBb0IsU0FBUSx1QkFBVTtJQUlsQyxZQUFZLFVBQTRCLEVBQUUsR0FBRyxFQUFFLEtBQUssUUFBUSxDQUFDLFFBQVEsS0FBSyxRQUFRLEdBQUcsR0FBRyxHQUFHLEVBQUUsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLEVBQUU7UUFDaEgsS0FBSyxDQUFDLElBQUksU0FBUyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUUzQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRyxhQUFhLENBQUM7UUFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLENBQUMsRUFBRSxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLENBQUMsR0FBRyxPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUM5RixJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDM0UsQ0FBQztJQUVTLFNBQVMsQ0FBQyxJQUFZO1FBQzVCLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNO1lBQy9CLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBRSxlQUFlO1lBRWxFLE1BQU0sS0FBSyxHQUFHLENBQUMsUUFBZ0I7Z0JBQzNCLFVBQVUsQ0FBQztvQkFDUCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUNwQyxPQUFPLEVBQUUsQ0FBQztvQkFDZCxDQUFDO29CQUFDLElBQUksQ0FBQyxDQUFDO3dCQUNKLEtBQUssQ0FBQyxRQUFRLElBQUksSUFBSSxHQUFHLElBQUksR0FBRyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVO29CQUM3RCxDQUFDO2dCQUNMLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUNqQixDQUFDLENBQUE7WUFFRCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDYixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxLQUFLO1FBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN6QixDQUFDO0NBQ0o7QUFuQ0Qsd0JBbUNDIiwiZmlsZSI6ImNsaWVudC9jbGFzc2VzL1NvY2tldC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VTb2NrZXQgfSBmcm9tIFwiLi4vLi4vQmFzZVNvY2tldC9jbGFzc2VzL0Jhc2VTb2NrZXRcIjtcclxuaW1wb3J0IHsgQmFzZVNvY2tldENvbmZpZyB9IGZyb20gXCIuLi8uLi9CYXNlU29ja2V0L2ludGVyZmFjZXMvQmFzZVNvY2tldENvbmZpZ1wiO1xyXG5cclxuaWYgKCFyZXF1aXJlKCdpcy1ub2RlJykpIEJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7XHJcbmNvbnN0IG5vZGVCdWZmZXJUb0FycmF5YnVmZmVyID0gcmVxdWlyZSgndG8tYXJyYXlidWZmZXInKTtcclxuXHJcbmV4cG9ydCBjbGFzcyBTb2NrZXQgZXh0ZW5kcyBCYXNlU29ja2V0IHtcclxuXHJcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgX3NvY2tldDogV2ViU29ja2V0O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGNvbmZpZ3M6IEJhc2VTb2NrZXRDb25maWcgPSB7IHVybDogYHdzJHtsb2NhdGlvbi5wcm90b2NvbCA9PT0gJ2h0dHBzOicgPyAncycgOiAnJ306Ly8ke2xvY2F0aW9uLmhvc3R9YCB9KSB7XHJcbiAgICAgICAgc3VwZXIobmV3IFdlYlNvY2tldChjb25maWdzLnVybCksIGNvbmZpZ3MpO1xyXG5cclxuICAgICAgICB0aGlzLl9zb2NrZXQuYmluYXJ5VHlwZSA9ICdhcnJheWJ1ZmZlcic7XHJcbiAgICAgICAgdGhpcy5fc29ja2V0Lm9ub3BlbiA9ICgpID0+IHRoaXMuZW1pdCgnb3BlbicpO1xyXG4gICAgICAgIHRoaXMuX3NvY2tldC5vbmNsb3NlID0gKGV2KSA9PiB0aGlzLmVtaXQoJ2Nsb3NlJywgZXYuY29kZSwgZXYucmVhc29uKTtcclxuICAgICAgICB0aGlzLl9zb2NrZXQub25lcnJvciA9IChlcnIpID0+IHsgY29uc29sZS5lcnJvcihlcnIpLCB0aGlzLmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKCfov57mjqXlvILluLgnKSk7IH1cclxuICAgICAgICB0aGlzLl9zb2NrZXQub25tZXNzYWdlID0gKGUpID0+IHRoaXMuX3JlY2VpdmVEYXRhKEJ1ZmZlci5mcm9tKGUuZGF0YSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBfc2VuZERhdGEoZGF0YTogQnVmZmVyKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5fc29ja2V0LnNlbmQobm9kZUJ1ZmZlclRvQXJyYXlidWZmZXIoZGF0YSkpOyAgLy/kuI3lj6/ku6Xnm7TmjqXlj5HpgIFidWZmZXJcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGNoZWNrID0gKGludGVydmFsOiBudW1iZXIpID0+IHtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9zb2NrZXQuYnVmZmVyZWRBbW91bnQgPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrKGludGVydmFsID49IDIwMDAgPyAyMDAwIDogaW50ZXJ2YWwgKiAyKTsgLy/mnIDmhaIy56eS5qOA5p+l5LiA5qyhXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSwgaW50ZXJ2YWwpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjaGVjaygxKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjbG9zZSgpIHtcclxuICAgICAgICB0aGlzLl9zb2NrZXQuY2xvc2UoKTtcclxuICAgIH1cclxufSJdfQ==
